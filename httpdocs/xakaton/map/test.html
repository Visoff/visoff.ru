<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=1, initial-scale=1.0">
    <title>Map testing</title>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
        }
        body {
            margin: 0;
        }
        .leaflet-top.leaflet-right, .leaflet-bottom.leaflet-right {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="../api/back.js"></script>
    <script>
        function buildPath(coords) {
            var waypoints = path.getWaypoints()
                waypoints[1].latLng = coords
                path.setWaypoints(waypoints)
        }
        parent.goTo = function(pos) {
            window.map.panTo({lat:0, lng:0})
            console.log(map.panTo(new L.latLng(pos[0], pos[1])))
        }
        function update() {
            window.citymarkers = JSON.parse(parent.Marker.getMarkers())
            for (var i = 0; i < citymarkers.length; i++) {
                citymarkers[i].pos = JSON.parse(citymarkers[i].pos)
                L.marker(citymarkers[i].pos, {icon:pointIcon}).on("click", function(event) {
                    for (var i = 0; i < citymarkers.length; i++) {
                        if (event.latlng.lat == citymarkers[i].pos[0] && event.latlng.lng == citymarkers[i].pos[1]) {
                            parent.dialogOpen(citymarkers[i])
                        }
                    }
                    buildPath(event.latlng)
                }).addTo(map)
            }
        }
        onload = function () {
            map = L.map('map', {center: [55, 73.4], zoom:18})
            var osm = L.tileLayer ('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            map.on('click', function (event) {
                var coords = event.latlng
                pointMarker.setLatLng([coords.lat, coords.lng])
                if (window != parent) {
                    parent.document.querySelector(".create").hidden = false;
                    parent.Marker.pos = [Math.floor(coords.lat*10000)/10000, Math.floor(coords.lng*10000)/10000]
                }
            })
            
            userIcon = L.icon({iconUrl:"../icon/userIcon.svg", iconSize: [30, 30]})
            pointIcon = L.icon({iconUrl:"../icon/pointIcon.svg", iconSize: [50, 50]})
            window.userMarker = L.marker([0, 0], {icon:userIcon})
            navigator.geolocation.getCurrentPosition(function (event) {
                var pos = [event.coords.latitude, event.coords.longitude]
                map.panTo(new L.latLng(pos[0], pos[1]))
                userMarker.addTo(map)
                pointMarker = L.marker([0, 0], {icon:pointIcon}).addTo(map)
                window.path = L.Routing.control({waypoints:[pos], createMarker: function() { return L.marker([0, 0], {opacity:0}); }}).addTo(map)
            }, function (error) {}, {enableHighAccuracy:true, timeout:10, maximumAge:0})
            update()
            setInterval(update, 1000)
        }
    </script>
</head>
<body>
    <div id="map"></div>
    <!--button style="position: fixed; top:0;left:10px; z-index:1000;" onclick="localStorage.setItem('token', 'null')">clear</!button-->
    <script>
        token = localStorage.getItem("p.token")
        if (token == undefined || token == "null") {parent.parent.location = "https://visoff.ru/xakaton/"}
        navigator.geolocation.watchPosition(function(event) {
            markers = []
            pos = [event.coords.latitude, event.coords.longitude]
            userMarker.setLatLng(pos)
            if (path != undefined) {
                var waypoints = path.getWaypoints()
                waypoints[0].latLng = {lat:pos[0], lng:pos[1]}
                path.setWaypoints(waypoints)
            }
            var data = {pos:[Math.floor(pos[0]*10000)/10000, Math.floor(pos[1]*10000)/10000], token:token}
            if (pointMarker._latlng.lat != 0) {
                data.point = [Math.floor(pointMarker._latlng.lat*10000)/10000, Math.floor(pointMarker._latlng.lng*10000)/10000]
            }
            other = req("POST", "updatePos.php", data)
            other = JSON.parse(other)
            for (var i = 0; i < other.length; i++) {
                if (!other[i]) {continue}
                pos = JSON.parse(other[i])
                markers[i] = L.marker(pos, {icon:userIcon}).addTo(map)
            }
        }, function (error) {}, {enableHighAccuracy:true, timeout:10, maximumAge:0})
    </script>
</body>
</html>